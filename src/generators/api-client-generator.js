/**
 * API Client Generator
 * Generates API client code for the project
 */

const fs = require('fs');
const path = require('path');

class ApiClientGenerator {
  /**
   * Generate API client file
   */
  generate(options) {
    const {
      projectPath,
      apiKey,
      backendUrl,
      organizationId,
      isTypeScript,
    } = options;

    // Determine output path based on project structure
    const libDir = fs.existsSync(path.join(projectPath, 'src'))
      ? path.join(projectPath, 'src', 'lib')
      : path.join(projectPath, 'lib');

    // Ensure lib directory exists
    if (!fs.existsSync(libDir)) {
      fs.mkdirSync(libDir, { recursive: true });
    }

    const extension = isTypeScript ? 'ts' : 'js';
    const outputPath = path.join(libDir, `api-client.${extension}`);

    // Generate API client code
    const code = this.generateCode({
      apiKey,
      backendUrl,
      organizationId,
      isTypeScript,
    });

    fs.writeFileSync(outputPath, code, 'utf8');
    return outputPath;
  }

  /**
   * Generate API client code
   */
  generateCode({ apiKey, backendUrl, organizationId, isTypeScript }) {
    const returnType = isTypeScript ? ': Promise<any>' : '';

    return `/**
 * L4YERCAK3 API Client
 * Auto-generated by @l4yercak3/cli
 * 
 * This client handles authenticated requests to the L4YERCAK3 backend API.
 * Organization ID: ${organizationId}
 */

// Using native fetch (available in Next.js 13+)

class L4YERCAK3Client {
  constructor(apiKey${isTypeScript ? ': string' : ''} = '${apiKey}', baseUrl${isTypeScript ? ': string' : ''} = '${backendUrl}') {
    this.apiKey = apiKey;
    this.baseUrl = baseUrl;
    this.organizationId = '${organizationId}';
  }

  /**
   * Make authenticated API request
   */
  async request(endpoint${isTypeScript ? ': string' : ''}, options${isTypeScript ? ': RequestInit' : ''} = {})${returnType} {
    const url = \`\${this.baseUrl}\${endpoint}\`;
    const headers = {
      'Content-Type': 'application/json',
      'Authorization': \`Bearer \${this.apiKey}\`,
      'X-Organization-Id': this.organizationId,
      ...options.headers,
    };

    const response = await fetch(url, {
      ...options,
      headers,
    });

    if (!response.ok) {
      const error = await response.json().catch(() => ({ message: 'Request failed' }));
      throw new Error(error.message || \`API request failed: \${response.status}\`);
    }

    return response.json();
  }

  /**
   * CRM Methods
   */

  async getContacts()${returnType} {
    return this.request('/api/v1/crm/contacts');
  }

  async getContact(contactId${isTypeScript ? ': string' : ''})${returnType} {
    return this.request(\`/api/v1/crm/contacts/\${contactId}\`);
  }

  async createContact(data${isTypeScript ? ': any' : ''})${returnType} {
    return this.request('/api/v1/crm/contacts', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  }

  async updateContact(contactId${isTypeScript ? ': string' : ''}, data${isTypeScript ? ': any' : ''})${returnType} {
    return this.request(\`/api/v1/crm/contacts/\${contactId}\`, {
      method: 'PATCH',
      body: JSON.stringify(data),
    });
  }

  async deleteContact(contactId${isTypeScript ? ': string' : ''})${returnType} {
    return this.request(\`/api/v1/crm/contacts/\${contactId}\`, {
      method: 'DELETE',
    });
  }

  /**
   * Projects Methods
   */

  async getProjects()${returnType} {
    return this.request('/api/v1/projects');
  }

  async getProject(projectId${isTypeScript ? ': string' : ''})${returnType} {
    return this.request(\`/api/v1/projects/\${projectId}\`);
  }

  async createProject(data${isTypeScript ? ': any' : ''})${returnType} {
    return this.request('/api/v1/projects', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  }

  async updateProject(projectId${isTypeScript ? ': string' : ''}, data${isTypeScript ? ': any' : ''})${returnType} {
    return this.request(\`/api/v1/projects/\${projectId}\`, {
      method: 'PATCH',
      body: JSON.stringify(data),
    });
  }

  async deleteProject(projectId${isTypeScript ? ': string' : ''})${returnType} {
    return this.request(\`/api/v1/projects/\${projectId}\`, {
      method: 'DELETE',
    });
  }

  /**
   * Invoices Methods
   */

  async getInvoices()${returnType} {
    return this.request('/api/v1/invoices');
  }

  async getInvoice(invoiceId${isTypeScript ? ': string' : ''})${returnType} {
    return this.request(\`/api/v1/invoices/\${invoiceId}\`);
  }

  async createInvoice(data${isTypeScript ? ': any' : ''})${returnType} {
    return this.request('/api/v1/invoices', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  }

  async updateInvoice(invoiceId${isTypeScript ? ': string' : ''}, data${isTypeScript ? ': any' : ''})${returnType} {
    return this.request(\`/api/v1/invoices/\${invoiceId}\`, {
      method: 'PATCH',
      body: JSON.stringify(data),
    });
  }

  async deleteInvoice(invoiceId${isTypeScript ? ': string' : ''})${returnType} {
    return this.request(\`/api/v1/invoices/\${invoiceId}\`, {
      method: 'DELETE',
    });
  }
}

${isTypeScript ? 'export default L4YERCAK3Client;' : 'module.exports = L4YERCAK3Client;'}
`;
  }
}

module.exports = new ApiClientGenerator();
