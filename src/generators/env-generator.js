/**
 * Environment File Generator
 * Generates .env.local file with configuration
 */

const fs = require('fs');
const path = require('path');

class EnvGenerator {
  /**
   * Generate or update .env.local file
   */
  generate(options) {
    const {
      projectPath,
      apiKey,
      backendUrl,
      organizationId,
      features,
      oauthProviders,
    } = options;

    const envPath = path.join(projectPath, '.env.local');
    const existingEnv = this.readExistingEnv(envPath);

    // Merge with new values
    const envVars = {
      ...existingEnv,
      // Core API configuration
      L4YERCAK3_API_KEY: apiKey,
      L4YERCAK3_BACKEND_URL: backendUrl,
      L4YERCAK3_ORGANIZATION_ID: organizationId,
      NEXT_PUBLIC_L4YERCAK3_BACKEND_URL: backendUrl,
    };

    // Add OAuth variables if OAuth is enabled
    if (features.includes('oauth') && oauthProviders) {
      if (oauthProviders.includes('google')) {
        envVars.GOOGLE_CLIENT_ID = existingEnv.GOOGLE_CLIENT_ID || 'your_google_client_id_here';
        envVars.GOOGLE_CLIENT_SECRET = existingEnv.GOOGLE_CLIENT_SECRET || 'your_google_client_secret_here';
      }
      if (oauthProviders.includes('microsoft')) {
        envVars.AZURE_CLIENT_ID = existingEnv.AZURE_CLIENT_ID || 'your_azure_client_id_here';
        envVars.AZURE_CLIENT_SECRET = existingEnv.AZURE_CLIENT_SECRET || 'your_azure_client_secret_here';
        envVars.AZURE_TENANT_ID = existingEnv.AZURE_TENANT_ID || 'your_azure_tenant_id_here';
      }
      if (oauthProviders.includes('github')) {
        envVars.GITHUB_CLIENT_ID = existingEnv.GITHUB_CLIENT_ID || 'your_github_client_id_here';
        envVars.GITHUB_CLIENT_SECRET = existingEnv.GITHUB_CLIENT_SECRET || 'your_github_client_secret_here';
      }
      envVars.NEXTAUTH_URL = existingEnv.NEXTAUTH_URL || 'http://localhost:3000';
      envVars.NEXTAUTH_SECRET = existingEnv.NEXTAUTH_SECRET || 'generate_with_openssl_rand_base64_32';
    }

    // Add Stripe variables if Stripe is enabled
    if (features.includes('stripe')) {
      envVars.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY = existingEnv.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY || 'your_stripe_publishable_key_here';
      envVars.STRIPE_SECRET_KEY = existingEnv.STRIPE_SECRET_KEY || 'your_stripe_secret_key_here';
      envVars.STRIPE_WEBHOOK_SECRET = existingEnv.STRIPE_WEBHOOK_SECRET || 'your_stripe_webhook_secret_here';
    }

    // Write env file
    const envContent = this.formatEnvFile(envVars);
    fs.writeFileSync(envPath, envContent, 'utf8');

    return envPath;
  }

  /**
   * Read existing .env.local file
   */
  readExistingEnv(envPath) {
    const envVars = {};
    
    if (!fs.existsSync(envPath)) {
      return envVars;
    }

    try {
      const content = fs.readFileSync(envPath, 'utf8');
      const lines = content.split('\n');
      
      for (const line of lines) {
        const trimmed = line.trim();
        if (trimmed && !trimmed.startsWith('#')) {
          const match = trimmed.match(/^([^=]+)=(.*)$/);
          if (match) {
            const key = match[1].trim();
            const value = match[2].trim();
            envVars[key] = value;
          }
        }
      }
    } catch (error) {
      // Error reading file, return empty object
    }

    return envVars;
  }

  /**
   * Format environment variables as .env file
   */
  formatEnvFile(envVars) {
    let content = `# L4YERCAK3 Configuration
# Auto-generated by @l4yercak3/cli
# DO NOT commit this file to git - it contains sensitive credentials

# Core API Configuration
L4YERCAK3_API_KEY=${envVars.L4YERCAK3_API_KEY}
L4YERCAK3_BACKEND_URL=${envVars.L4YERCAK3_BACKEND_URL}
L4YERCAK3_ORGANIZATION_ID=${envVars.L4YERCAK3_ORGANIZATION_ID}
NEXT_PUBLIC_L4YERCAK3_BACKEND_URL=${envVars.NEXT_PUBLIC_L4YERCAK3_BACKEND_URL}

`;

    // Add OAuth section if present
    if (envVars.GOOGLE_CLIENT_ID || envVars.AZURE_CLIENT_ID || envVars.GITHUB_CLIENT_ID) {
      content += `# OAuth Configuration
`;
      if (envVars.GOOGLE_CLIENT_ID) {
        content += `GOOGLE_CLIENT_ID=${envVars.GOOGLE_CLIENT_ID}
GOOGLE_CLIENT_SECRET=${envVars.GOOGLE_CLIENT_SECRET}

`;
      }
      if (envVars.AZURE_CLIENT_ID) {
        content += `AZURE_CLIENT_ID=${envVars.AZURE_CLIENT_ID}
AZURE_CLIENT_SECRET=${envVars.AZURE_CLIENT_SECRET}
AZURE_TENANT_ID=${envVars.AZURE_TENANT_ID}

`;
      }
      if (envVars.GITHUB_CLIENT_ID) {
        content += `GITHUB_CLIENT_ID=${envVars.GITHUB_CLIENT_ID}
GITHUB_CLIENT_SECRET=${envVars.GITHUB_CLIENT_SECRET}

`;
      }
      if (envVars.NEXTAUTH_URL) {
        content += `NEXTAUTH_URL=${envVars.NEXTAUTH_URL}
NEXTAUTH_SECRET=${envVars.NEXTAUTH_SECRET}

`;
      }
    }

    // Add Stripe section if present
    if (envVars.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY) {
      content += `# Stripe Configuration
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${envVars.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
STRIPE_SECRET_KEY=${envVars.STRIPE_SECRET_KEY}
STRIPE_WEBHOOK_SECRET=${envVars.STRIPE_WEBHOOK_SECRET}

`;
    }

    return content;
  }
}

module.exports = new EnvGenerator();
