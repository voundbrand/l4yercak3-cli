/**
 * NextAuth.js Configuration Generator
 * Generates NextAuth.js configuration for OAuth providers
 */

const fs = require('fs');
const path = require('path');
const { checkFileOverwrite, writeFileWithBackup, ensureDir } = require('../utils/file-utils');

class NextAuthGenerator {
  /**
   * Generate NextAuth.js configuration
   * @param {Object} options - Generation options
   * @returns {Promise<string|null>} - Path to generated file or null if skipped
   */
  async generate(options) {
    const {
      projectPath,
      backendUrl,
      oauthProviders,
      routerType,
      isTypeScript,
    } = options;

    // Determine API route path based on router type
    const apiDir = routerType === 'app'
      ? path.join(projectPath, 'app', 'api', 'auth')
      : path.join(projectPath, 'pages', 'api', 'auth');

    // Ensure directory exists
    ensureDir(apiDir);

    const extension = isTypeScript ? 'ts' : 'js';
    const routePath = routerType === 'app'
      ? path.join(apiDir, `[...nextauth]`, `route.${extension}`)
      : path.join(apiDir, `[...nextauth].${extension}`);

    // Ensure [...nextauth] directory exists for App Router
    if (routerType === 'app') {
      const nextauthDir = path.join(apiDir, '[...nextauth]');
      ensureDir(nextauthDir);
    }

    // Check if file exists and get action
    const action = await checkFileOverwrite(routePath);

    if (action === 'skip') {
      return null;
    }

    // Generate NextAuth configuration
    const code = this.generateCode({
      backendUrl,
      oauthProviders,
      routerType,
      isTypeScript,
    });

    return writeFileWithBackup(routePath, code, action);
  }

  /**
   * Generate NextAuth.js code
   */
  generateCode({ oauthProviders, routerType, isTypeScript }) {
    const providers = [];
    const providerImports = [];

    if (oauthProviders.includes('google')) {
      providerImports.push("import GoogleProvider from 'next-auth/providers/google';");
      providers.push(`      GoogleProvider({
        clientId: process.env.GOOGLE_CLIENT_ID${isTypeScript ? '!' : ''},
        clientSecret: process.env.GOOGLE_CLIENT_SECRET${isTypeScript ? '!' : ''},
      }),`);
    }

    if (oauthProviders.includes('microsoft')) {
      providerImports.push("import AzureADProvider from 'next-auth/providers/azure-ad';");
      providers.push(`      AzureADProvider({
        clientId: process.env.AZURE_CLIENT_ID${isTypeScript ? '!' : ''},
        clientSecret: process.env.AZURE_CLIENT_SECRET${isTypeScript ? '!' : ''},
        tenantId: process.env.AZURE_TENANT_ID${isTypeScript ? '!' : ''},
      }),`);
    }

    if (oauthProviders.includes('github')) {
      providerImports.push("import GitHubProvider from 'next-auth/providers/github';");
      providers.push(`      GitHubProvider({
        clientId: process.env.GITHUB_CLIENT_ID${isTypeScript ? '!' : ''},
        clientSecret: process.env.GITHUB_CLIENT_SECRET${isTypeScript ? '!' : ''},
      }),`);
    }

    const providersCode = providers.join('\n');

    // App Router vs Pages Router
    if (routerType === 'app') {
      return `/**
 * NextAuth.js Configuration
 * Auto-generated by @l4yercak3/cli
 * 
 * This file configures OAuth authentication for your frontend application.
 * Users authenticated here are automatically synced to your L4YERCAK3 backend.
 */

${providerImports.join('\n')}
import NextAuth from 'next-auth';
import type { NextAuthOptions } from 'next-auth';

const authOptions${isTypeScript ? ': NextAuthOptions' : ''} = {
  providers: [
${providersCode}
  ],
  callbacks: {
    async signIn({ user, account, profile }) {
      if (!account) return false;

      try {
        // Sync user to L4YERCAK3 backend
        const response = await fetch(\`\${process.env.NEXT_PUBLIC_L4YERCAK3_BACKEND_URL}/api/v1/auth/sync-user\`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': \`Bearer \${process.env.L4YERCAK3_API_KEY}\`,
          },
          body: JSON.stringify({
            email: user.email,
            name: user.name,
            image: user.image,
            provider: account.provider,
            providerAccountId: account.providerAccountId,
            accessToken: account.access_token,
            refreshToken: account.refresh_token,
            expiresAt: account.expires_at,
          }),
        });

        if (!response.ok) {
          console.error('Failed to sync user to backend:', await response.text());
          return false;
        }

        const backendUser = await response.json();
        
        // Add backend user ID to session
        user.id = backendUser.userId;
        user.organizationId = backendUser.organizationId;
        
        return true;
      } catch (error) {
        console.error('Error syncing user to backend:', error);
        return false;
      }
    },
    async session({ session, user${isTypeScript ? ': any' : ''} }) {
      if (session.user) {
        session.user.id = user.id;
        session.user.organizationId = user.organizationId;
      }
      return session;
    },
  },
  pages: {
    signIn: '/auth/signin',
  },
};

const handler = NextAuth(authOptions);

export { handler as GET, handler as POST };
`;
    } else {
      // Pages Router
      return `/**
 * NextAuth.js Configuration
 * Auto-generated by @l4yercak3/cli
 * 
 * This file configures OAuth authentication for your frontend application.
 * Users authenticated here are automatically synced to your L4YERCAK3 backend.
 */

${providerImports.join('\n')}
import NextAuth from 'next-auth';

export default NextAuth({
  providers: [
${providersCode}
  ],
  callbacks: {
    async signIn({ user, account, profile }) {
      if (!account) return false;

      try {
        // Sync user to L4YERCAK3 backend
        const response = await fetch(\`\${process.env.NEXT_PUBLIC_L4YERCAK3_BACKEND_URL}/api/v1/auth/sync-user\`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': \`Bearer \${process.env.L4YERCAK3_API_KEY}\`,
          },
          body: JSON.stringify({
            email: user.email,
            name: user.name,
            image: user.image,
            provider: account.provider,
            providerAccountId: account.providerAccountId,
            accessToken: account.access_token,
            refreshToken: account.refresh_token,
            expiresAt: account.expires_at,
          }),
        });

        if (!response.ok) {
          console.error('Failed to sync user to backend:', await response.text());
          return false;
        }

        const backendUser = await response.json();
        
        // Add backend user ID to session
        user.id = backendUser.userId;
        user.organizationId = backendUser.organizationId;
        
        return true;
      } catch (error) {
        console.error('Error syncing user to backend:', error);
        return false;
      }
    },
    async session({ session, user }) {
      if (session.user) {
        session.user.id = user.id;
        session.user.organizationId = user.organizationId;
      }
      return session;
    },
  },
  pages: {
    signIn: '/auth/signin',
  },
});
`;
    }
  }
}

module.exports = new NextAuthGenerator();
